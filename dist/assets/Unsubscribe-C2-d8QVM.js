import{M as _,bh as F,r as a,W as m,j as e,X as D,P as x,a0 as L,a2 as P,a3 as b}from"./index-q1shbo1Y.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const h=_("ArrowLeft",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]),C=()=>{const[w]=F(),r=w.get("token"),[n,N]=a.useState(null),[v,f]=a.useState(!0),[g,i]=a.useState(""),[p,y]=a.useState(!1),[S,c]=a.useState(!1),[l,k]=a.useState("1");a.useEffect(()=>{if(!r){i("Invalid unsubscribe link - missing token"),f(!1);return}E()},[r]);const E=async()=>{try{console.log("üîç Fetching subscriber for token:",r);const{data:t,error:s}=await m.from("email_subscribers").select("email, status, unsubscribe_token").eq("unsubscribe_token",r).single();if(console.log("üìã Database query result:",{data:t,error:s,token:r}),s){console.error("‚ùå Error fetching subscriber:",s),i(`Invalid unsubscribe link: ${s.message}`);return}if(!t){console.error("‚ùå No subscriber found for token:",r),i("Subscriber not found");return}console.log("‚úÖ Found subscriber:",t),N(t),t.status==="unsubscribed"&&(console.log("‚ÑπÔ∏è Subscriber already unsubscribed"),c(!0))}catch(t){console.error("‚ùå Fetch error:",t),i("Failed to load unsubscribe page")}finally{f(!1)}},I=async t=>{t.preventDefault(),y(!0);try{if(console.log("üìß Processing unsubscribe for token:",r,"reason:",l),(n==null?void 0:n.status)==="unsubscribed"){c(!0),b.success("Already unsubscribed");return}console.log("üîÑ Attempting edge function call...");try{const{data:s,error:o}=await m.functions.invoke("newsletter-unsubscribe",{body:{token:r,reason:l}});if(console.log("üì® Edge function response:",{data:s,error:o}),o)throw console.error("Edge function error:",o),new Error("Edge function failed");if(s!=null&&s.success){console.log("‚úÖ Edge function unsubscribe successful"),c(!0),b.success("Successfully unsubscribed from newsletter");return}else throw new Error((s==null?void 0:s.error)||"Edge function returned unsuccessful")}catch(s){console.warn("‚ö†Ô∏è Edge function failed, trying direct database update:",s),console.log("üîÑ Attempting direct database update...");const{data:o,error:R}=await m.from("email_subscribers").select("id, email, status, unsubscribe_token").eq("unsubscribe_token",r);if(console.log("üîç Token verification:",{token:r,tokenCheck:o,tokenError:R}),!o||o.length===0)throw new Error(`No subscriber found with unsubscribe_token: ${r}`);const j=o[0];console.log("üìã Record to update:",j);const{data:d,error:u}=await m.from("email_subscribers").update({status:"unsubscribed",unsubscribed_at:new Date().toISOString(),unsubscribe_reason:l,updated_at:new Date().toISOString()}).eq("id",j.id).select();if(console.log("üìù Update by ID result:",{updateByIdResult:d,updateByIdError:u}),u)throw console.error("‚ùå Database update by ID error:",u),u;if(!d||d.length===0)throw console.error("‚ùå No records were updated by ID. This suggests RLS/permissions issue"),new Error("Update blocked - likely Row Level Security or permissions issue");console.log("‚úÖ Direct database update successful - Updated records:",d.length),c(!0),b.success("Successfully unsubscribed from newsletter")}}catch(s){console.error("‚ùå Complete unsubscribe failure:",s),i("Failed to unsubscribe. Please try again."),b.error("Failed to unsubscribe. Please try again.")}finally{y(!1)}};return v?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsx("div",{className:"bg-white rounded-2xl p-8 shadow-lg max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-4 text-textSecondary",children:"Loading unsubscribe page..."})]})})}):g?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsx("div",{className:"bg-white rounded-2xl p-8 shadow-lg max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(D,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-text mb-4",children:"Error"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-red-700 font-medium",children:g})}),e.jsx("p",{className:"text-textSecondary mb-6",children:"Please contact our support team if you continue to experience issues."}),e.jsxs(x,{to:"/",className:"inline-flex items-center gap-2 bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors",children:[e.jsx(h,{className:"w-4 h-4"}),"Return to Oentex"]})]})})}):S?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsx("div",{className:"bg-white rounded-2xl p-8 shadow-lg max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(L,{className:"w-16 h-16 text-green-500 mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-text mb-4",children:"Successfully Unsubscribed"}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsx("p",{className:"text-green-700 font-medium",children:"You have been removed from our newsletter list"})}),e.jsx("p",{className:"text-textSecondary mb-4",children:"We're sorry to see you go! If you change your mind, you can always resubscribe on our website."}),e.jsxs("p",{className:"text-sm text-textSecondary mb-6",children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.email]}),e.jsxs(x,{to:"/",className:"inline-flex items-center gap-2 bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-primary/90 transition-colors",children:[e.jsx(h,{className:"w-4 h-4"}),"Return to Oentex"]})]})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsxs("div",{className:"bg-white rounded-2xl p-8 shadow-lg max-w-md w-full mx-4",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(P,{className:"w-16 h-16 text-primary mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-bold text-text mb-2",children:"Unsubscribe from Newsletter"}),e.jsx("p",{className:"text-textSecondary",children:"We're sorry to see you go!"})]}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-6",children:e.jsxs("p",{className:"text-sm text-textSecondary",children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.email]})}),e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"reason",className:"block text-sm font-medium text-text mb-2",children:"Why are you unsubscribing? (Optional)"}),e.jsxs("select",{id:"reason",value:l,onChange:t=>k(t.target.value),className:"w-full px-4 py-3 border border-border rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all",children:[e.jsx("option",{value:"1",children:"Too many emails"}),e.jsx("option",{value:"2",children:"Content not relevant"}),e.jsx("option",{value:"3",children:"Never signed up"}),e.jsx("option",{value:"4",children:"Received spam"}),e.jsx("option",{value:"5",children:"Other reason"})]})]}),e.jsx("button",{type:"submit",disabled:p,className:"w-full bg-red-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Processing..."]}):e.jsx(e.Fragment,{children:"üóëÔ∏è Unsubscribe Me"})})]}),e.jsx("div",{className:"text-center mt-6",children:e.jsxs(x,{to:"/",className:"text-primary hover:text-primary/80 font-medium transition-colors inline-flex items-center gap-1",children:[e.jsx(h,{className:"w-4 h-4"}),"Return to Oentex"]})})]})})};export{C as default};
