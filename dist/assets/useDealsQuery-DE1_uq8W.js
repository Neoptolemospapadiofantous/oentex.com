var F=s=>{throw TypeError(s)};var C=(s,e,t)=>e.has(s)||F("Cannot "+t);var n=(s,e,t)=>(C(s,e,"read from private field"),t?t.call(s):e.get(s)),f=(s,e,t)=>e.has(s)?F("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),y=(s,e,t,a)=>(C(s,e,"write to private field"),a?a.call(s,t):e.set(s,t),t),b=(s,e,t)=>(C(s,e,"access private method"),t);import{u as $}from"./useQuery-BB20afus.js";import{bA as I,bB as G,bC as A,bD as x,bE as K,bF as M,r as v,bG as B,bH as N,W as c,V as k,a3 as O,bI as U,bJ as P}from"./index-q1shbo1Y.js";var _,h,u,g,d,E,q,D,Y=(D=class extends I{constructor(e,t){super();f(this,d);f(this,_);f(this,h);f(this,u);f(this,g);y(this,_,e),this.setOptions(t),this.bindMethods(),b(this,d,E).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var a;const t=this.options;this.options=n(this,_).defaultMutationOptions(e),G(this.options,t)||n(this,_).getMutationCache().notify({type:"observerOptionsUpdated",mutation:n(this,u),observer:this}),t!=null&&t.mutationKey&&this.options.mutationKey&&A(t.mutationKey)!==A(this.options.mutationKey)?this.reset():((a=n(this,u))==null?void 0:a.state.status)==="pending"&&n(this,u).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=n(this,u))==null||e.removeObserver(this)}onMutationUpdate(e){b(this,d,E).call(this),b(this,d,q).call(this,e)}getCurrentResult(){return n(this,h)}reset(){var e;(e=n(this,u))==null||e.removeObserver(this),y(this,u,void 0),b(this,d,E).call(this),b(this,d,q).call(this)}mutate(e,t){var a;return y(this,g,t),(a=n(this,u))==null||a.removeObserver(this),y(this,u,n(this,_).getMutationCache().build(n(this,_),this.options)),n(this,u).addObserver(this),n(this,u).execute(e)}},_=new WeakMap,h=new WeakMap,u=new WeakMap,g=new WeakMap,d=new WeakSet,E=function(){var t;const e=((t=n(this,u))==null?void 0:t.state)??x();y(this,h,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},q=function(e){K.batch(()=>{var t,a,r,i,o,l,m,S;if(n(this,g)&&this.hasListeners()){const p=n(this,h).variables,R=n(this,h).context;(e==null?void 0:e.type)==="success"?((a=(t=n(this,g)).onSuccess)==null||a.call(t,e.data,p,R),(i=(r=n(this,g)).onSettled)==null||i.call(r,e.data,null,p,R)):(e==null?void 0:e.type)==="error"&&((l=(o=n(this,g)).onError)==null||l.call(o,e.error,p,R),(S=(m=n(this,g)).onSettled)==null||S.call(m,void 0,e.error,p,R))}this.listeners.forEach(p=>{p(n(this,h))})})},D);function Q(s,e){const t=M(),[a]=v.useState(()=>new Y(t,s));v.useEffect(()=>{a.setOptions(s)},[a,s]);const r=v.useSyncExternalStore(v.useCallback(o=>a.subscribe(K.batchCalls(o)),[a]),()=>a.getCurrentResult(),()=>a.getCurrentResult()),i=v.useCallback((o,l)=>{a.mutate(o,l).catch(B)},[a]);if(r.error&&N(a.options.throwOnError,[r.error]))throw r.error;return{...r,mutate:i,mutateAsync:r.mutate}}const X=[{key:"platform_usability",label:"Platform Usability",required:!1},{key:"customer_support",label:"Customer Support",required:!1},{key:"fees_commissions",label:"Fees & Commissions",required:!1},{key:"security_trust",label:"Security & Trust",required:!1},{key:"educational_resources",label:"Educational Resources",required:!1},{key:"mobile_app",label:"Mobile App",required:!1}],T={async submitRating(s,e,t,a){try{console.log("🔄 Modern atomic rating submission starting..."),console.log("📊 Rating data:",t);const{data:r,error:i}=await c.rpc("submit_rating_transaction",{p_user_id:s,p_company_id:e,p_overall_rating:t.overall_rating||null,p_platform_usability:t.platform_usability||null,p_customer_support:t.customer_support||null,p_fees_commissions:t.fees_commissions||null,p_security_trust:t.security_trust||null,p_educational_resources:t.educational_resources||null,p_mobile_app:t.mobile_app||null,p_rating_type:t.overall_rating?"overall":"categories"});if(i)throw console.error("❌ Atomic transaction failed:",i),i;if(!r)throw new Error("No data returned from atomic transaction");return console.log("✅ Modern atomic transaction completed:",r),{data:r,error:null}}catch(r){return console.error("❌ Modern rating submission failed:",r),{data:null,error:r}}},async getUserRating(s,e){try{console.log("📊 Fetching user rating...");const{data:t,error:a}=await c.from("ratings").select("*").eq("user_id",s).eq("company_id",e).maybeSingle();if(a)return console.error("❌ Error fetching user rating:",a),null;if(!t)return null;let r="overall";return t.overall_rating?r="overall":(t.platform_usability||t.customer_support||t.fees_commissions||t.security_trust||t.educational_resources||t.mobile_app)&&(r="categories"),{...t,rating_type:r}}catch(t){return console.error("❌ Error in getUserRating:",t),null}},async getMultipleCompanyRatings(s){try{if(s.length===0)return{};console.log("📊 Batch fetching ratings for",s.length,"companies");const{data:e,error:t}=await c.from("trading_companies").select("id, overall_rating, total_reviews, name").in("id",s);if(t)return console.error("❌ Error fetching batch ratings:",t),{};const a={};return e==null||e.forEach(r=>{a[r.id]={averageRating:r.overall_rating||0,totalRatings:r.total_reviews||0},console.log(`📊 ${r.name}: ${r.overall_rating}⭐ (${r.total_reviews} reviews)`)}),a}catch(e){return console.error("❌ Error in getMultipleCompanyRatings:",e),{}}},async getCompanyAverageRating(s){try{console.log("📊 Fetching company rating from database...");const{data:e,error:t}=await c.from("trading_companies").select("overall_rating, total_reviews, name").eq("id",s).single();return t?(console.error("❌ Error fetching company rating:",t),{averageRating:0,totalRatings:0}):{averageRating:e.overall_rating||0,totalRatings:e.total_reviews||0,name:e.name}}catch(e){return console.error("❌ Error in getCompanyAverageRating:",e),{averageRating:0,totalRatings:0}}},async getCompanyRatings(s){try{console.log("📊 Fetching detailed company ratings...");const{data:e,error:t}=await c.from("ratings").select(`
          overall_rating,
          platform_usability,
          customer_support,
          fees_commissions,
          security_trust,
          educational_resources,
          mobile_app,
          rating_type,
          created_at
        `).eq("company_id",s).order("created_at",{ascending:!1});if(t)throw console.error("❌ Error fetching company ratings breakdown:",t),t;return e||[]}catch(e){throw console.error("❌ Error in getCompanyRatings:",e),e}},async debugRatingConsistency(s){try{console.log("🔍 DEBUG: Checking rating consistency...");const{data:e}=await c.from("trading_companies").select("name, overall_rating, total_reviews").eq("id",s).single(),{data:t}=await c.from("ratings").select("overall_rating, platform_usability, customer_support, rating_type").eq("company_id",s),a={company_name:e==null?void 0:e.name,stored_rating:e==null?void 0:e.overall_rating,stored_reviews:e==null?void 0:e.total_reviews,actual_ratings_count:(t==null?void 0:t.length)||0,ratings_sample:t==null?void 0:t.slice(0,3)};return console.log("🔍 DEBUG RESULTS:",a),a}catch(e){return console.error("❌ Debug check failed:",e),null}}},w=["deals"],L=["ratings"],z=async()=>{try{console.log("🔄 Fetching deals with real-time company ratings...");const{data:s,error:e}=await c.from("company_deals").select(`
        *,
        company:trading_companies(*)
      `).eq("is_active",!0).order("created_at",{ascending:!1});if(e)throw console.error("❌ Failed to fetch deals:",e),new Error(`Failed to fetch deals: ${e.message}`);if(!s)return{deals:[],companies:[]};const t=s.map(r=>{const i=Array.isArray(r.company)?r.company[0]:r.company;return(i==null?void 0:i.overall_rating)!==void 0&&console.log(`📊 ${i.name}: ${i.overall_rating}⭐ (${i.total_reviews} reviews)`),{id:r.id,company_id:r.company_id,title:r.title,description:r.description,deal_type:r.deal_type,value:r.value,terms:r.terms,start_date:r.start_date,end_date:r.end_date,is_active:r.is_active,click_count:r.click_count||0,conversion_rate:r.conversion_rate,affiliate_link:r.affiliate_link,created_at:r.created_at,updated_at:r.updated_at,company_name:(i==null?void 0:i.name)||"Unknown Company",category:(i==null?void 0:i.category)||r.deal_type,bonus_amount:r.value||"Special Offer",features:(i==null?void 0:i.features)||[],company:i?{...i,overall_rating:i.overall_rating||0,total_reviews:i.total_reviews||0}:void 0}}),a=t.map(r=>r.company).filter((r,i,o)=>r&&o.findIndex(l=>(l==null?void 0:l.id)===r.id)===i);return console.log(`✅ Fetched ${t.length} deals from ${a.length} companies`),{deals:t,companies:a}}catch(s){throw console.error("❌ Failed to fetch deals:",s),s}},Z=()=>{const{isFullyReady:s,error:e}=k();return $({queryKey:w,queryFn:z,staleTime:2*60*1e3,gcTime:10*60*1e3,retry:(t,a)=>{var r,i;return e||(r=a.message)!=null&&r.includes("unauthorized")||(i=a.message)!=null&&i.includes("forbidden")?!1:t<2},retryDelay:t=>Math.min(1e3*2**t,5e3),enabled:s,refetchOnMount:!0,refetchOnWindowFocus:!1,refetchOnReconnect:!0})},W=async(s,e)=>{if(e.length===0)return new Map;try{const t=await Promise.allSettled(e.map(async r=>{const i=await T.getUserRating(s,r);return{companyId:r,userRating:i}})),a=new Map;return t.forEach(r=>{if(r.status==="fulfilled"){const{companyId:i,userRating:o}=r.value;o&&a.set(i,o)}}),a}catch(t){throw console.error("❌ Failed to fetch user ratings:",t),t}},ee=(s,e)=>{const{isFullyReady:t,user:a,session:r,error:i}=k();return $({queryKey:[...L,"user",s,...e.sort()],queryFn:()=>W(s,e),enabled:t&&!!r&&!!s&&!!a&&e.length>0,staleTime:60*1e3,gcTime:5*60*1e3,retry:(o,l)=>{var m;return i||(m=l.message)!=null&&m.includes("unauthorized")?!1:o<1}})},te=()=>{const s=M();return Q({mutationFn:async e=>{const{data:t,error:a}=await c.from("company_deals").update({click_count:c.sql`click_count + 1`}).eq("id",e).select().single();if(a)throw a;return t},onSuccess:e=>{s.setQueryData(w,t=>t!=null&&t.deals?{...t,deals:t.deals.map(a=>a.id===e.id?{...a,click_count:e.click_count}:a)}:t)},onError:e=>{console.error("❌ Failed to track deal click:",e)}})},re=()=>{const s=M(),{isFullyReady:e,user:t,session:a}=k();return Q({mutationFn:async r=>{if(!e||!t||!a)throw new Error("Authentication required");if(r.userId!==t.id)throw new Error("User ID mismatch");console.log("🔄 Modern rating submission starting...");const i=await T.submitRating(r.userId,r.companyId,r.ratings,r.existingRating);if(i.error)throw i.error;if(!i.data)throw new Error("No data returned from rating submission");return i.data},onMutate:async r=>{console.log("🚀 Starting optimistic update for ALL cards..."),await s.cancelQueries({queryKey:w});const i=s.getQueryData(w),o=r.ratings.overall_rating||j(r.ratings),l=P(r.companyId),m=((l==null?void 0:l.total_reviews)||0)+1;return U(r.companyId,{overall_rating:o,total_reviews:m}),console.log(`✅ Optimistic update: ALL cards now show ${o}⭐ (${m} reviews)`),{previousDeals:i}},onSuccess:(r,i)=>{console.log("✅ Rating submission successful - updating with real data..."),U(i.companyId,{overall_rating:r.overall_rating,total_reviews:r.total_reviews}),s.invalidateQueries({queryKey:[...L,"user",i.userId]}),console.log(`✅ ALL cards updated: ${r.overall_rating}⭐ (${r.total_reviews} reviews)`),O.success("Rating submitted successfully!")},onError:(r,i,o)=>{console.error("❌ Rating submission failed - rolling back updates..."),o!=null&&o.previousDeals&&s.setQueryData(w,o.previousDeals),console.log("✅ Optimistic updates rolled back"),O.error("Failed to submit rating. Please try again.")},retry:(r,i)=>{var o,l;return(o=i.message)!=null&&o.includes("Authentication required")||(l=i.message)!=null&&l.includes("User ID mismatch")?!1:r<1}})};function j(s){const e=[s.platform_usability,s.customer_support,s.fees_commissions,s.security_trust,s.educational_resources,s.mobile_app].filter(t=>t&&t>0);return e.length>0?Math.round(e.reduce((t,a)=>t+a,0)/e.length*10)/10:0}export{X as R,ee as a,te as b,re as c,Z as u};
