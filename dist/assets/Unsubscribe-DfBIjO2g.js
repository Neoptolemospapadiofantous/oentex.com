import{r as a,j as e}from"./heroui-0ik-TEjB.js";import{c as _,L as b}from"./router-Cc6Kb6KN.js";import{s as m,I as i,b as x,a as D}from"./index-B7y_UsvS.js";import"./query-CmYTTArA.js";const P=()=>{const[j]=_(),s=j.get("token"),[n,N]=a.useState(null),[v,f]=a.useState(!0),[g,h]=a.useState(""),[p,y]=a.useState(!1),[k,c]=a.useState(!1),[l,S]=a.useState("1");a.useEffect(()=>{if(!s){h("Invalid unsubscribe link - missing token"),f(!1);return}E()},[s]);const E=async()=>{try{console.log("üîç Fetching subscriber for token:",s);const{data:t,error:r}=await m.from("email_subscribers").select("email, status, unsubscribe_token").eq("unsubscribe_token",s).single();if(console.log("üìã Database query result:",{data:t,error:r,token:s}),r){console.warn("‚ö†Ô∏è Error fetching subscriber (non-blocking):",r);return}if(!t){console.warn("‚ö†Ô∏è No subscriber found for token (non-blocking):",s);return}console.log("‚úÖ Found subscriber:",t),N(t),t.status==="unsubscribed"&&(console.log("‚ÑπÔ∏è Subscriber already unsubscribed"),c(!0))}catch(t){console.error("‚ùå Fetch error:",t),console.warn("‚ö†Ô∏è Non-fatal fetch error; proceeding without subscriber context")}finally{f(!1)}},I=async t=>{t.preventDefault(),y(!0);try{if(console.log("üìß Processing unsubscribe for token:",s,"reason:",l),(n==null?void 0:n.status)==="unsubscribed"){c(!0),x("Already unsubscribed");return}console.log("üîÑ Attempting edge function call...");try{const{data:r,error:o}=await m.functions.invoke("newsletter-unsubscribe",{body:{token:s,reason:l}});if(console.log("üì® Edge function response:",{data:r,error:o}),o)throw console.error("Edge function error:",o),new Error("Edge function failed");if(r!=null&&r.success){console.log("‚úÖ Edge function unsubscribe successful"),c(!0),x("Successfully unsubscribed from newsletter");return}else throw new Error((r==null?void 0:r.error)||"Edge function returned unsuccessful")}catch(r){console.warn("‚ö†Ô∏è Edge function failed, trying direct database update:",r),console.log("üîÑ Attempting direct database update...");const{data:o,error:R}=await m.from("email_subscribers").select("id, email, status, unsubscribe_token").eq("unsubscribe_token",s);if(console.log("üîç Token verification:",{token:s,tokenCheck:o,tokenError:R}),!o||o.length===0)throw new Error(`No subscriber found with unsubscribe_token: ${s}`);const w=o[0];console.log("üìã Record to update:",w);const{data:d,error:u}=await m.from("email_subscribers").update({status:"unsubscribed",unsubscribed_at:new Date().toISOString(),unsubscribe_reason:l,updated_at:new Date().toISOString()}).eq("id",w.id).select();if(console.log("üìù Update by ID result:",{updateByIdResult:d,updateByIdError:u}),u)throw console.error("‚ùå Database update by ID error:",u),u;if(!d||d.length===0)throw console.error("‚ùå No records were updated by ID. This suggests RLS/permissions issue"),new Error("Update blocked - likely Row Level Security or permissions issue");console.log("‚úÖ Direct database update successful - Updated records:",d.length),c(!0),x("Successfully unsubscribed from newsletter")}}catch(r){console.error("‚ùå Complete unsubscribe failure:",r),h("Failed to unsubscribe. Please try again."),D("Failed to unsubscribe. Please try again.")}finally{y(!1)}};return v?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsx("div",{className:"bg-content1 rounded-2xl container-p-2xl shadow-lg max-w-md w-full container-p-md",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"}),e.jsx("p",{className:"mt-6 text-foreground/70",children:"Loading unsubscribe page..."})]})})}):g?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsx("div",{className:"bg-content1 rounded-2xl container-p-2xl shadow-lg max-w-md w-full container-p-md",children:e.jsxs("div",{className:"text-center",children:[e.jsx(i.warning,{className:"w-16 h-16 text-red-500 mx-auto mb-6"}),e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-6",children:"Error"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg container-p-md mb-8",children:e.jsx("p",{className:"text-red-700 font-medium",children:g})}),e.jsx("p",{className:"text-foreground/70 mb-8",children:"Please contact our support team if you continue to experience issues."}),e.jsxs(b,{to:"/",className:"inline-flex items-center gap-2 bg-primary text-white container-px-lg container-py-sm rounded-lg font-medium hover:bg-primary/90 transition-colors",children:[e.jsx(i.arrowLeft,{className:"w-4 h-4"}),"Return to Oentex"]})]})})}):k?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsx("div",{className:"bg-content1 rounded-2xl container-p-2xl shadow-lg max-w-md w-full container-p-md",children:e.jsxs("div",{className:"text-center",children:[e.jsx(i.success,{className:"w-16 h-16 text-green-500 mx-auto mb-6"}),e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-6",children:"Successfully Unsubscribed"}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg container-p-md mb-8",children:e.jsx("p",{className:"text-green-700 font-medium",children:"You have been removed from our newsletter list"})}),e.jsx("p",{className:"text-foreground/70 mb-6",children:"We're sorry to see you go! If you change your mind, you can always resubscribe on our website."}),e.jsxs("p",{className:"text-sm text-foreground/70 mb-8",children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.email]}),e.jsxs(b,{to:"/",className:"inline-flex items-center gap-2 bg-primary text-white container-px-lg container-py-sm rounded-lg font-medium hover:bg-primary/90 transition-colors",children:[e.jsx(i.arrowLeft,{className:"w-4 h-4"}),"Return to Oentex"]})]})})}):e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-primary/10 via-secondary/5 to-accent/10 flex items-center justify-center",children:e.jsxs("div",{className:"bg-content1 rounded-2xl container-p-2xl shadow-lg max-w-md w-full container-p-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(i.mail,{className:"w-16 h-16 text-primary mx-auto mb-6"}),e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-3",children:"Unsubscribe from Newsletter"}),e.jsx("p",{className:"text-foreground/70",children:"We're sorry to see you go!"})]}),e.jsx("div",{className:"bg-content2 rounded-lg container-p-md mb-8",children:e.jsxs("p",{className:"text-sm text-foreground/70",children:[e.jsx("strong",{children:"Email:"})," ",n==null?void 0:n.email]})}),e.jsxs("form",{onSubmit:I,className:"space-y-8",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"reason",className:"block text-sm font-medium text-foreground mb-3",children:"Why are you unsubscribing? (Optional)"}),e.jsxs("select",{id:"reason",value:l,onChange:t=>S(t.target.value),className:"w-full container-px-md container-py-sm border border-border rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all",children:[e.jsx("option",{value:"1",children:"Too many emails"}),e.jsx("option",{value:"2",children:"Content not relevant"}),e.jsx("option",{value:"3",children:"Never signed up"}),e.jsx("option",{value:"4",children:"Received spam"}),e.jsx("option",{value:"5",children:"Other reason"})]})]}),e.jsx("button",{type:"submit",disabled:p,className:"w-full bg-red-500 text-white container-py-sm container-px-lg rounded-lg font-medium hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Processing..."]}):e.jsx(e.Fragment,{children:"üóëÔ∏è Unsubscribe Me"})})]}),e.jsx("div",{className:"text-center mt-8",children:e.jsxs(b,{to:"/",className:"text-primary hover:text-primary/80 font-medium transition-colors inline-flex items-center gap-1",children:[e.jsx(i.arrowLeft,{className:"w-4 h-4"}),"Return to Oentex"]})})]})})};export{P as default};
