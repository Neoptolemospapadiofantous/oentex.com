import"./heroui-0ik-TEjB.js";import{u as v,b as k,c as b}from"./query-CmYTTArA.js";import{s as _,u as h,b as C,a as q}from"./index-8n21VcdY.js";const S=[{key:"platform_usability",label:"Platform Usability",required:!1},{key:"customer_support",label:"Customer Support",required:!1},{key:"fees_commissions",label:"Fees & Commissions",required:!1},{key:"security_trust",label:"Security & Trust",required:!1},{key:"educational_resources",label:"Educational Resources",required:!1},{key:"mobile_app",label:"Mobile App",required:!1}],R={async submitRating(n,t,e,s){try{console.log("🔄 Modern atomic rating submission starting..."),console.log("📊 Rating data:",e);const{data:a,error:l}=await _.rpc("submit_rating_transaction",{p_user_id:n,p_company_id:t,p_overall_rating:e.overall_rating||null,p_platform_usability:e.platform_usability||null,p_customer_support:e.customer_support||null,p_fees_commissions:e.fees_commissions||null,p_security_trust:e.security_trust||null,p_educational_resources:e.educational_resources||null,p_mobile_app:e.mobile_app||null,p_rating_type:e.overall_rating?"overall":"categories"});if(l)throw console.error("❌ Atomic transaction failed:",l),l;if(!a)throw new Error("No data returned from atomic transaction");return console.log("✅ Modern atomic transaction completed:",a),{data:a,error:null}}catch(a){return console.error("❌ Modern rating submission failed:",a),{data:null,error:a}}},async getUserRating(n,t){try{console.log("📊 Fetching user rating...");const{data:e,error:s}=await _.from("ratings").select("*").eq("user_id",n).eq("company_id",t).maybeSingle();if(s)return console.error("❌ Error fetching user rating:",s),null;if(!e)return null;let a="overall";return e.overall_rating?a="overall":(e.platform_usability||e.customer_support||e.fees_commissions||e.security_trust||e.educational_resources||e.mobile_app)&&(a="categories"),{...e,rating_type:a}}catch(e){return console.error("❌ Error in getUserRating:",e),null}},async getMultipleCompanyRatings(n){try{if(n.length===0)return{};console.log("📊 Batch fetching ratings for",n.length,"companies");const{data:t,error:e}=await _.from("trading_companies").select("id, overall_rating, total_reviews, name").in("id",n);if(e)return console.error("❌ Error fetching batch ratings:",e),{};const s={};return t==null||t.forEach(a=>{s[a.id]={averageRating:a.overall_rating||0,totalRatings:a.total_reviews||0},console.log(`📊 ${a.name}: ${a.overall_rating}⭐ (${a.total_reviews} reviews)`)}),s}catch(t){return console.error("❌ Error in getMultipleCompanyRatings:",t),{}}},async getCompanyAverageRating(n){try{console.log("📊 Fetching company rating from database...");const{data:t,error:e}=await _.from("trading_companies").select("overall_rating, total_reviews, name").eq("id",n).single();return e?(console.error("❌ Error fetching company rating:",e),{averageRating:0,totalRatings:0}):{averageRating:t.overall_rating||0,totalRatings:t.total_reviews||0,name:t.name}}catch(t){return console.error("❌ Error in getCompanyAverageRating:",t),{averageRating:0,totalRatings:0}}},async getCompanyRatings(n){try{console.log("📊 Fetching detailed company ratings...");const{data:t,error:e}=await _.from("ratings").select(`
          overall_rating,
          platform_usability,
          customer_support,
          fees_commissions,
          security_trust,
          educational_resources,
          mobile_app,
          rating_type,
          created_at
        `).eq("company_id",n).order("created_at",{ascending:!1});if(e)throw console.error("❌ Error fetching company ratings breakdown:",e),e;return t||[]}catch(t){throw console.error("❌ Error in getCompanyRatings:",t),t}},async debugRatingConsistency(n){try{console.log("🔍 DEBUG: Checking rating consistency...");const{data:t}=await _.from("trading_companies").select("name, overall_rating, total_reviews").eq("id",n).single(),{data:e}=await _.from("ratings").select("overall_rating, platform_usability, customer_support, rating_type").eq("company_id",n),s={company_name:t==null?void 0:t.name,stored_rating:t==null?void 0:t.overall_rating,stored_reviews:t==null?void 0:t.total_reviews,actual_ratings_count:(e==null?void 0:e.length)||0,ratings_sample:e==null?void 0:e.slice(0,3)};return console.log("🔍 DEBUG RESULTS:",s),s}catch(t){return console.error("❌ Debug check failed:",t),null}}},M=()=>{const{isFullyReady:n}=h();return v({queryKey:["deals"],queryFn:async()=>{try{console.log("🔄 Fetching deals and companies...");const{data:t,error:e}=await _.from("company_deals").select(`
            id,
            company_id,
            title,
            description,
            deal_type,
            value,
            terms,
            start_date,
            end_date,
            is_active,
            click_count,
            conversion_rate,
            affiliate_link,
            created_at,
            updated_at,
            company:trading_companies!company_deals_company_id_fkey (
              id,
              name,
              slug,
              description,
              logo_url,
              website_url,
              category,
              affiliate_link,
              overall_rating,
              total_reviews,
              status
            )
          `).eq("is_active",!0).not("company","is",null).order("created_at",{ascending:!1});if(e)throw new Error(`Failed to fetch deals: ${e.message}`);const{data:s,error:a}=await _.from("trading_companies").select(`
            id,
            name,
            slug,
            description,
            logo_url,
            website_url,
            category,
            affiliate_link,
            overall_rating,
            total_reviews,
            status
          `).eq("status","active");if(a)throw new Error(`Failed to fetch companies: ${a.message}`);if(!t||!s)return{deals:[],companies:[],totalCount:0,totalCompaniesCount:0,totalDealsCount:0};const l=t.filter(r=>r.company&&r.company.status==="active").map(r=>{var g,m,f,d;return{id:r.id,company_id:r.company_id,title:r.title,description:r.description,deal_type:r.deal_type,value:r.value,terms:r.terms,start_date:r.start_date||r.created_at,end_date:r.end_date,is_active:r.is_active,click_count:r.click_count||0,conversion_rate:r.conversion_rate||0,affiliate_link:r.affiliate_link,created_at:r.created_at,updated_at:r.updated_at,company:r.company,company_name:((g=r.company)==null?void 0:g.name)||"",merchant_name:(m=r.company)==null?void 0:m.name,category:(f=r.company)==null?void 0:f.category,rating:(d=r.company)==null?void 0:d.overall_rating,bonus_amount:r.value,features:[],tracking_link:r.affiliate_link}}),u=s.map(r=>({id:r.id,name:r.name,slug:r.slug,description:r.description,logo_url:r.logo_url,website_url:r.website_url,category:r.category,affiliate_link:r.affiliate_link,overall_rating:r.overall_rating,total_reviews:r.total_reviews,status:r.status}));return console.log("✅ Deals and companies fetched successfully:",{dealsCount:l.length,companiesCount:u.length}),{deals:l,companies:u,totalCount:l.length,totalCompaniesCount:u.length,totalDealsCount:l.length}}catch(t){throw console.error("❌ Failed to fetch deals:",t),t}},enabled:n,staleTime:5*60*1e3,gcTime:10*60*1e3,retry:(t,e)=>{var s,a;return(s=e.message)!=null&&s.includes("permission")||(a=e.message)!=null&&a.includes("policy")?!1:t<2}})},U=(n=1,t=12,e={})=>{const{isFullyReady:s}=h();return v({queryKey:["paginated-deals",n,t,e],queryFn:async()=>{try{console.log("🔄 Fetching paginated deals...",{page:n,limit:t,filters:e});const a=(n-1)*t;try{return await E(n,t,e)}catch(l){return console.warn("⚠️ Paginated query failed, falling back to original query:",l),await D(n,t,e)}}catch(a){throw console.error("❌ Failed to fetch paginated deals:",a),a}},enabled:s,staleTime:2*60*1e3,gcTime:5*60*1e3,retry:(a,l)=>{var u,r;return(u=l.message)!=null&&u.includes("permission")||(r=l.message)!=null&&r.includes("policy")?!1:a<2}})};async function E(n,t,e){const s=(n-1)*t;let a=_.from("company_deals").select(`
      id,
      company_id,
      title,
      description,
      deal_type,
      value,
      terms,
      start_date,
      end_date,
      is_active,
      click_count,
      conversion_rate,
      affiliate_link,
      created_at,
      updated_at,
      company:trading_companies!company_deals_company_id_fkey (
        id,
        name,
        slug,
        description,
        logo_url,
        website_url,
        category,
        affiliate_link,
        overall_rating,
        total_reviews,
        status
      )
    `,{count:"exact"}).eq("is_active",!0).not("company","is",null);switch(e.category&&e.category!=="all"&&(a=a.eq("company.category",e.category)),e.searchTerm&&(a=a.or(`title.ilike.%${e.searchTerm}%,description.ilike.%${e.searchTerm}%`)),e.sortBy){case"newest":a=a.order("created_at",{ascending:!1});break;case"popular":a=a.order("click_count",{ascending:!1});break;case"rating":a=a.order("created_at",{ascending:!1});break;case"name":a=a.order("created_at",{ascending:!1});break;default:a=a.order("created_at",{ascending:!1})}a=a.range(s,s+t-1);const{data:l,error:u,count:r}=await a;if(console.log("📊 Paginated query result:",{dealsCount:(l==null?void 0:l.length)||0,totalCount:r,page:n,limit:t,offset:s,filters:e}),u)throw console.error("❌ Paginated deals error:",u),new Error(`Failed to fetch deals: ${u.message}`);const{data:g,error:m}=await _.from("trading_companies").select(`
      id,
      name,
      slug,
      description,
      logo_url,
      website_url,
      category,
      affiliate_link,
      overall_rating,
      total_reviews,
      status
    `).eq("status","active");if(m)throw new Error(`Failed to fetch companies: ${m.message}`);if(!l)return console.warn("⚠️ No deals data returned from paginated query"),{deals:[],companies:g||[],totalCount:0,totalCompaniesCount:(g==null?void 0:g.length)||0,totalDealsCount:0};if(!g)return console.warn("⚠️ No companies data returned"),{deals:[],companies:[],totalCount:0,totalCompaniesCount:0,totalDealsCount:0};const f=l.filter(i=>i.company&&i.company.status==="active").map(i=>{var o,c,p,y;return{id:i.id,company_id:i.company_id,title:i.title,description:i.description,deal_type:i.deal_type,value:i.value,terms:i.terms,start_date:i.start_date||i.created_at,end_date:i.end_date,is_active:i.is_active,click_count:i.click_count||0,conversion_rate:i.conversion_rate||0,affiliate_link:i.affiliate_link,created_at:i.created_at,updated_at:i.updated_at,company:i.company,company_name:((o=i.company)==null?void 0:o.name)||"",merchant_name:(c=i.company)==null?void 0:c.name,category:(p=i.company)==null?void 0:p.category,rating:(y=i.company)==null?void 0:y.overall_rating,bonus_amount:i.value,features:[],tracking_link:i.affiliate_link}}),d=g.map(i=>({id:i.id,name:i.name,slug:i.slug,description:i.description,logo_url:i.logo_url,website_url:i.website_url,category:i.category,affiliate_link:i.affiliate_link,overall_rating:i.overall_rating,total_reviews:i.total_reviews,status:i.status}));return console.log("✅ Paginated deals fetched successfully:",{dealsCount:f.length,companiesCount:d.length,totalCount:r||0}),{deals:f,companies:d,totalCount:r||0,totalCompaniesCount:d.length,totalDealsCount:r||0}}async function D(n,t,e){console.log("🔄 Using fallback client-side pagination...",{page:n,limit:t,filters:e});const{data:s,error:a}=await _.from("company_deals").select(`
      id,
      company_id,
      title,
      description,
      deal_type,
      value,
      terms,
      start_date,
      end_date,
      is_active,
      click_count,
      conversion_rate,
      affiliate_link,
      created_at,
      updated_at,
      company:trading_companies!company_deals_company_id_fkey (
        id,
        name,
        slug,
        description,
        logo_url,
        website_url,
        category,
        affiliate_link,
        overall_rating,
        total_reviews,
        status
      )
    `).eq("is_active",!0).not("company","is",null).order("created_at",{ascending:!1});if(a)throw new Error(`Failed to fetch deals: ${a.message}`);const{data:l,error:u}=await _.from("trading_companies").select(`
      id,
      name,
      slug,
      description,
      logo_url,
      website_url,
      category,
      affiliate_link,
      overall_rating,
      total_reviews,
      status
    `).eq("status","active");if(u)throw new Error(`Failed to fetch companies: ${u.message}`);if(!s||!l)return{deals:[],companies:[],totalCount:0,totalCompaniesCount:0,totalDealsCount:0};let r=s.filter(o=>o.company&&o.company.status==="active").map(o=>{var c,p,y,w;return{id:o.id,company_id:o.company_id,title:o.title,description:o.description,deal_type:o.deal_type,value:o.value,terms:o.terms,start_date:o.start_date||o.created_at,end_date:o.end_date,is_active:o.is_active,click_count:o.click_count||0,conversion_rate:o.conversion_rate||0,affiliate_link:o.affiliate_link,created_at:o.created_at,updated_at:o.updated_at,company:o.company,company_name:((c=o.company)==null?void 0:c.name)||"",merchant_name:(p=o.company)==null?void 0:p.name,category:(y=o.company)==null?void 0:y.category,rating:(w=o.company)==null?void 0:w.overall_rating,bonus_amount:o.value,features:[],tracking_link:o.affiliate_link}});if(e.searchTerm){const o=e.searchTerm.toLowerCase();r=r.filter(c=>c.company_name.toLowerCase().includes(o)||c.title.toLowerCase().includes(o)||c.description.toLowerCase().includes(o))}e.category&&e.category!=="all"&&(r=r.filter(o=>{var c;return((c=o.company)==null?void 0:c.category)===e.category})),r.sort((o,c)=>{var p,y;switch(e.sortBy){case"rating":return(((p=c.company)==null?void 0:p.overall_rating)||0)-(((y=o.company)==null?void 0:y.overall_rating)||0);case"newest":return new Date(c.created_at).getTime()-new Date(o.created_at).getTime();case"popular":return(c.click_count||0)-(o.click_count||0);case"name":return o.company_name.localeCompare(c.company_name);default:return 0}});const g=r.length,m=(n-1)*t,f=m+t,d=r.slice(m,f),i=l.map(o=>({id:o.id,name:o.name,slug:o.slug,description:o.description,logo_url:o.logo_url,website_url:o.website_url,category:o.category,affiliate_link:o.affiliate_link,overall_rating:o.overall_rating,total_reviews:o.total_reviews,status:o.status}));return console.log("✅ Client-side paginated deals fetched successfully:",{dealsCount:d.length,totalCount:g,page:n,limit:t}),{deals:d,companies:i,totalCount:g,totalCompaniesCount:i.length,totalDealsCount:g}}const $=(n,t)=>{const{isFullyReady:e}=h();return v({queryKey:["user-ratings",n,t],queryFn:async()=>{if(!n||t.length===0)return{};try{console.log("🔄 Fetching user ratings for",t.length,"companies...");const{data:s,error:a}=await _.from("ratings").select("*").eq("user_id",n).in("company_id",t);if(a)return console.error("❌ Error fetching user ratings:",a),{};const l={};return s==null||s.forEach(u=>{l[u.company_id]=u}),console.log("✅ User ratings fetched:",Object.keys(l).length,"ratings"),l}catch(s){return console.error("❌ Failed to fetch user ratings:",s),{}}},enabled:e&&!!n&&t.length>0,staleTime:2*60*1e3,gcTime:5*60*1e3})},K=()=>{const n=k();return b({mutationFn:async({dealId:t})=>{try{console.log("🔄 Updating deal click count for deal:",t);const{error:e}=await _.rpc("increment_deal_clicks",{deal_id:t});if(e)throw e;return console.log("✅ Deal click count updated successfully"),{success:!0}}catch(e){throw console.error("❌ Failed to update deal click count:",e),e}},onSuccess:()=>{n.invalidateQueries({queryKey:["deals"]}),n.invalidateQueries({queryKey:["featured-deals"]})}})},P=()=>{const n=k();return b({mutationFn:async({userId:t,companyId:e,ratings:s,existingRating:a})=>{console.log("🔄 Submitting rating via mutation hook...");const l=await R.submitRating(t,e,s,a);if(l.error)throw l.error;return l.data},onMutate:async({companyId:t})=>(await n.cancelQueries({queryKey:["deals"]}),await n.cancelQueries({queryKey:["company-ratings",t]}),{previousDeals:n.getQueryData(["deals"])}),onError:(t,e,s)=>{console.error("❌ Rating submission failed:",t),q("Failed to submit rating. Please try again."),s!=null&&s.previousDeals&&n.setQueryData(["deals"],s.previousDeals)},onSuccess:(t,{companyId:e})=>{console.log("✅ Rating submitted successfully:",t),C("Rating submitted successfully!"),n.invalidateQueries({queryKey:["deals"]}),n.invalidateQueries({queryKey:["company-ratings",e]}),n.invalidateQueries({queryKey:["featured-deals"]})}})};export{S as R,$ as a,K as b,M as c,P as d,U as u};
